'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var babel = require('babel-core'); // lol

_bluebird2.default.promisifyAll(_fs2.default);
_bluebird2.default.promisifyAll(babel);

var logger = {
	log: function log() {
		var _console;

		return (_console = console).log.apply(_console, arguments);
	},
	warn: function warn() {
		var _console2;

		return (_console2 = console).warn.apply(_console2, arguments);
	},
	error: function error() {
		var _console3;

		return (_console3 = console).error.apply(_console3, arguments);
	}
};

exports.default = function (src, babelOpts) {
	var resolvePath = function () {
		var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(urlPath) {
			var localPath;
			return _regenerator2.default.wrap(function _callee$(_context) {
				while (1) {
					switch (_context.prev = _context.next) {
						case 0:
							localPath = _path2.default.resolve(src, urlPath);

							if (!(localPath.indexOf(basePath) === 0)) {
								_context.next = 3;
								break;
							}

							return _context.abrupt('return', localPath);

						case 3:
							_context.prev = 3;
							_context.next = 6;
							return _fs2.default.accessAsync(localPath, _fs2.default.R_OK);

						case 6:
							return _context.abrupt('return', localPath);

						case 9:
							_context.prev = 9;
							_context.t0 = _context['catch'](3);

							logger.warn('Unable to read file ' + localPath);

						case 12:
						case 'end':
							return _context.stop();
					}
				}
			}, _callee, this, [[3, 9]]);
		}));

		return function resolvePath(_x) {
			return _ref.apply(this, arguments);
		};
	}();

	var basePath = _path2.default.resolve(src);

	return function () {
		var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(req, res, next) {
			var pathToFile, _ref3, code, map, ast;

			return _regenerator2.default.wrap(function _callee2$(_context2) {
				while (1) {
					switch (_context2.prev = _context2.next) {
						case 0:
							_context2.prev = 0;
							_context2.next = 3;
							return resolvePath('.' + req.path);

						case 3:
							pathToFile = _context2.sent;

							if (!(pathToFile === undefined)) {
								_context2.next = 6;
								break;
							}

							return _context2.abrupt('return', next());

						case 6:
							_context2.next = 8;
							return babel.transformFileAsync(pathToFile, babelOpts);

						case 8:
							_ref3 = _context2.sent;
							code = _ref3.code;
							map = _ref3.map;
							ast = _ref3.ast;

							res.type('text/javascript');
							res.write(code);
							return _context2.abrupt('return', res.end());

						case 17:
							_context2.prev = 17;
							_context2.t0 = _context2['catch'](0);
							return _context2.abrupt('return', next(_context2.t0));

						case 20:
						case 'end':
							return _context2.stop();
					}
				}
			}, _callee2, undefined, [[0, 17]]);
		}));

		return function (_x2, _x3, _x4) {
			return _ref2.apply(this, arguments);
		};
	}();
};